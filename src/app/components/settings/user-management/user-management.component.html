<div class="user-management">
  <!-- Compact Header with Ocean Mint Theme -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <div class="header-icon">
          <mat-icon>people</mat-icon>
        </div>
        <div>
          <h1>User Management</h1>
          <p>Manage user accounts, roles, and permissions</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-icon-button
                (click)="refreshData()"
                class="refresh-btn"
                matTooltip="Refresh"
                [disabled]="isLoading">
          <mat-icon [class.spinning]="isLoading">refresh</mat-icon>
        </button>
        <button mat-button
                class="export-btn"
                (click)="exportUsers()"
                [disabled]="isLoading">
          <mat-icon>download</mat-icon>
          Export
        </button>
        <button mat-raised-button
                color="primary"
                (click)="openCreateUserDialog()"
                class="create-btn">
          <mat-icon>person_add</mat-icon>
          Add User
        </button>
      </div>
    </div>
  </div>

  <!-- Compact Stats Cards -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon total-icon">
        <mat-icon>people</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ totalUsers }}</h3>
        <p>Total Users</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon active-icon">
        <mat-icon>person</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ activeUsers }}</h3>
        <p>Active</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon admin-icon">
        <mat-icon>admin_panel_settings</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ adminUsers }}</h3>
        <p>Admins</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon groups-icon">
        <mat-icon>groups</mat-icon>
      </div>
      <div class="stat-content">
        <h3>{{ userGroups.length }}</h3>
        <p>Groups</p>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-banner" *ngIf="errorMessage">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
    <button mat-icon-button (click)="clearError()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-section" *ngIf="isLoading && !users.length">
    <mat-spinner diameter="40" color="primary"></mat-spinner>
    <p>Loading users...</p>
  </div>

  <!-- Users Content -->
  <div class="users-container" *ngIf="!isLoading || users.length > 0">
    <!-- Compact Filters -->
    <div class="filters-section">
      <mat-form-field appearance="outline" class="search-field ocean-mint-field">
        <mat-label>Search users</mat-label>
        <input matInput
               [(ngModel)]="searchQuery"
               (ngModelChange)="onSearchChange()"
               placeholder="Name, email, username...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field ocean-mint-field">
        <mat-label>Status</mat-label>
        <mat-select [(value)]="statusFilter" (selectionChange)="applyFilters()">
          <mat-option value="all">All Users</mat-option>
          <mat-option value="active">Active Only</mat-option>
          <mat-option value="inactive">Inactive Only</mat-option>
          <mat-option value="admin">Administrators</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field ocean-mint-field">
        <mat-label>User Type</mat-label>
        <mat-select [(value)]="userTypeFilter" (selectionChange)="applyFilters()">
          <mat-option value="">All Types</mat-option>
          <mat-option *ngFor="let type of userTypes" [value]="type.code">
            {{ type.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field ocean-mint-field">
        <mat-label>Group</mat-label>
        <mat-select [(value)]="groupFilter" (selectionChange)="applyFilters()">
          <mat-option [value]="null">All Groups</mat-option>
          <mat-option *ngFor="let group of userGroups" [value]="group.id">
            {{ group.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button
              class="clear-filters-btn"
              (click)="clearFilters()"
              matTooltip="Clear filters"
              *ngIf="searchQuery || statusFilter !== 'all' || userTypeFilter || groupFilter">
        <mat-icon>clear</mat-icon>
      </button>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" *ngIf="selection.length > 0">
      <span class="selection-count">{{ selection.length }} selected</span>
      <button mat-button (click)="bulkActivate()">
        <mat-icon>check_circle</mat-icon>
        Activate
      </button>
      <button mat-button (click)="bulkDeactivate()">
        <mat-icon>cancel</mat-icon>
        Deactivate
      </button>
      <button mat-button (click)="clearSelection()">
        <mat-icon>clear</mat-icon>
        Clear
      </button>
    </div>

    <!-- Compact Users Table -->
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="users-table">
        <!-- Selection Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="toggleAllSelection($event)"
                          [checked]="isAllSelected()"
                          [indeterminate]="isSomeSelected()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let user">
            <mat-checkbox (change)="toggleSelection(user)"
                          [checked]="isSelected(user)"
                          (click)="$event.stopPropagation()">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- User Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="username">User</th>
          <td mat-cell *matCellDef="let user" class="user-cell">
            <div class="user-info">
              <div class="user-avatar" [style.background]="getUserAvatarColor(user)">
                <span>{{ getUserInitials(user) }}</span>
              </div>
              <div class="user-details">
                <div class="user-name">
                  {{ user.first_name }} {{ user.second_name || '' }} {{ user.third_name || '' }} {{ user.last_name }}
                </div>
                <div class="user-username">&#64;{{ user.username }}</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="email">Email</th>
          <td mat-cell *matCellDef="let user" class="email-cell">
            <a [href]="'mailto:' + user.email">{{ user.email }}</a>
          </td>
        </ng-container>

        <!-- User Type Column -->
        <ng-container matColumnDef="userType">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let user">
            <mat-chip *ngIf="user.user_type" class="type-chip">
              {{ user.user_type.name }}
            </mat-chip>
            <span *ngIf="!user.user_type" class="no-type">-</span>
          </td>
        </ng-container>

        <!-- Role Column -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Role</th>
          <td mat-cell *matCellDef="let user">
            <div class="role-chips">
              <mat-chip *ngIf="user.is_superuser" class="role-chip superuser">
                Super Admin
              </mat-chip>
              <mat-chip *ngIf="user.is_staff && !user.is_superuser" class="role-chip staff">
                Staff
              </mat-chip>
              <mat-chip *ngIf="user.is_developer" class="role-chip developer">
                Developer
              </mat-chip>
              <mat-chip *ngFor="let group of user.groups" class="role-chip group">
                {{ group.name }}
              </mat-chip>
              <mat-chip *ngIf="!user.is_staff && !user.is_superuser && !user.is_developer && (!user.groups || user.groups.length === 0)"
                        class="role-chip user">
                User
              </mat-chip>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="is_active">Status</th>
          <td mat-cell *matCellDef="let user">
            <div class="status-indicator" [class]="user.is_active ? 'active' : 'inactive'">
              <span class="status-dot"></span>
              <span class="status-text">{{ user.is_active ? 'Active' : 'Inactive' }}</span>
            </div>
            <div class="account-status" *ngIf="!user.activated_account">
              <mat-icon class="warning-icon">warning</mat-icon>
              <span>Not verified</span>
            </div>
          </td>
        </ng-container>

        <!-- Last Login Column -->
        <ng-container matColumnDef="lastLogin">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="last_login">Last Login</th>
          <td mat-cell *matCellDef="let user" class="last-login-cell">
            {{ formatDate(user.last_login) }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let user" class="actions-cell">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" class="action-btn">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="viewUser(user)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              <button mat-menu-item (click)="editUser(user)">
                <mat-icon>edit</mat-icon>
                <span>Edit</span>
              </button>
              <button mat-menu-item (click)="toggleUserStatus(user)">
                <mat-icon>{{ user.is_active ? 'visibility_off' : 'visibility' }}</mat-icon>
                <span>{{ user.is_active ? 'Deactivate' : 'Activate' }}</span>
              </button>
              <button mat-menu-item (click)="resetPassword(user)">
                <mat-icon>lock_reset</mat-icon>
                <span>Reset Password</span>
              </button>
              <button mat-menu-item (click)="managePhoneNumbers(user)">
                <mat-icon>phone</mat-icon>
                <span>Phone Numbers</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item
                      (click)="deleteUser(user)"
                      [disabled]="user.is_superuser || currentUser?.id === user.id"
                      class="delete-item">
                <mat-icon>delete</mat-icon>
                <span>Delete</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            class="user-row"
            [class.selected]="isSelected(row)"
            (click)="viewUser(row)"></tr>
      </table>

      <mat-paginator [length]="totalUsers"
                     [pageSize]="pageSize"
                     [pageSizeOptions]="[10, 25, 50, 100]"
                     [pageIndex]="currentPage"
                     (page)="onPageChange($event)"
                     showFirstLastButtons
                     class="table-paginator">
      </mat-paginator>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="users.length === 0 && !isLoading">
      <mat-icon>people</mat-icon>
      <h3>No users found</h3>
      <p>
        {{ searchQuery || statusFilter !== 'all' || userTypeFilter || groupFilter ?
        'Try adjusting your filters' :
        'Create your first user' }}
      </p>
      <button mat-raised-button
              class="create-btn"
              (click)="searchQuery || statusFilter !== 'all' || userTypeFilter || groupFilter ? clearFilters() : openCreateUserDialog()">
        <mat-icon>{{ searchQuery || statusFilter !== 'all' || userTypeFilter || groupFilter ? 'clear' : 'person_add' }}</mat-icon>
        {{ searchQuery || statusFilter !== 'all' || userTypeFilter || groupFilter ? 'Clear Filters' : 'Create User' }}
      </button>
    </div>
  </div>
</div>

<!-- Compact Edit User Dialog -->
<ng-template #editUserDialog>
  <h2 mat-dialog-title>
    <mat-icon>{{ editingUser?.id ? 'edit' : 'person_add' }}</mat-icon>
    {{ editingUser?.id ? 'Edit' : 'Create' }} User
  </h2>

  <mat-dialog-content class="dialog-content">
    <mat-tab-group class="user-tabs" animationDuration="300ms">
      <!-- Basic Information Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">person</mat-icon>
          <span class="tab-label">Basic Info</span>
        </ng-template>

        <form [formGroup]="userForm" class="compact-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>First Name</mat-label>
              <input matInput formControlName="first_name">
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="userForm.get('first_name')?.hasError('required')">
                First name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Second Name</mat-label>
              <input matInput formControlName="second_name">
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Third Name</mat-label>
              <input matInput formControlName="third_name">
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="last_name">
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="userForm.get('last_name')?.hasError('required')">
                Last name is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Username</mat-label>
              <input matInput formControlName="username" (blur)="checkUsernameAvailability()">
              <mat-icon matPrefix>alternate_email</mat-icon>
              <mat-error *ngIf="userForm.get('username')?.hasError('required')">
                Username is required
              </mat-error>
              <mat-error *ngIf="userForm.get('username')?.hasError('pattern')">
                Only letters, numbers, and underscores
              </mat-error>
              <mat-error *ngIf="userForm.get('username')?.hasError('notAvailable')">
                Username is already taken
              </mat-error>
              <mat-hint *ngIf="checkingUsername">
                <mat-spinner diameter="16" style="display: inline-block; margin-right: 4px;"></mat-spinner>
                Checking availability...
              </mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email">
              <mat-icon matPrefix>email</mat-icon>
              <mat-error *ngIf="userForm.get('email')?.hasError('required')">
                Email is required
              </mat-error>
              <mat-error *ngIf="userForm.get('email')?.hasError('email')">
                Please enter a valid email
              </mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="ocean-mint-field">
            <mat-label>User Type</mat-label>
            <mat-select formControlName="user_type_id">
              <mat-option [value]="null">No type assigned</mat-option>
              <mat-option *ngFor="let type of userTypes" [value]="type.id">
                {{ type.name }} ({{ type.code }})
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="ocean-mint-field" *ngIf="!editingUser?.id">
            <mat-label>Password</mat-label>
            <input matInput [type]="showPassword ? 'text' : 'password'" formControlName="password" (input)="checkPasswordStrength()">
            <mat-icon matPrefix>lock</mat-icon>
            <button mat-icon-button matSuffix (click)="showPassword = !showPassword" type="button">
              <mat-icon>{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="userForm.get('password')?.hasError('required')">
              Password is required
            </mat-error>
            <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
              Password must be at least 8 characters
            </mat-error>
            <mat-error *ngIf="userForm.get('password')?.hasError('pattern')">
              Must contain upper, lower, number & special char
            </mat-error>
            <mat-hint>Min 8 chars with upper, lower, number & special char</mat-hint>
          </mat-form-field>

          <!-- Password Strength Indicator -->
          <div class="password-strength" *ngIf="!editingUser?.id && userForm.get('password')?.value">
            <div class="strength-label">Password Strength:</div>
            <div class="strength-bar">
              <div class="strength-progress"
                   [style.width.%]="passwordStrength.score * 25"
                   [class.weak]="passwordStrength.score <= 1"
                   [class.fair]="passwordStrength.score === 2"
                   [class.good]="passwordStrength.score === 3"
                   [class.strong]="passwordStrength.score === 4">
              </div>
            </div>
            <div class="strength-text"
                 [class.weak]="passwordStrength.score <= 1"
                 [class.fair]="passwordStrength.score === 2"
                 [class.good]="passwordStrength.score === 3"
                 [class.strong]="passwordStrength.score === 4">
              {{ passwordStrength.text }}
            </div>
          </div>

          <div class="checkbox-section">
            <mat-checkbox formControlName="is_active" class="styled-checkbox">
              <span class="checkbox-label">Active User</span>
              <span class="checkbox-description">User can log in and access the system</span>
            </mat-checkbox>
            <mat-checkbox formControlName="activated_account" class="styled-checkbox">
              <span class="checkbox-label">Account Verified</span>
              <span class="checkbox-description">User has verified their email/phone</span>
            </mat-checkbox>
            <mat-checkbox formControlName="is_staff" class="styled-checkbox">
              <span class="checkbox-label">Staff Status</span>
              <span class="checkbox-description">User can access the admin interface</span>
            </mat-checkbox>
            <mat-checkbox formControlName="is_developer" class="styled-checkbox">
              <span class="checkbox-label">Developer Status</span>
              <span class="checkbox-description">User has developer privileges</span>
            </mat-checkbox>
            <mat-checkbox formControlName="is_superuser" class="styled-checkbox">
              <span class="checkbox-label">Superuser Status</span>
              <span class="checkbox-description">User has all permissions without explicitly assigning them</span>
            </mat-checkbox>
          </div>
        </form>
      </mat-tab>

      <!-- Groups & Permissions Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">security</mat-icon>
          <span class="tab-label">Groups</span>
        </ng-template>

        <div class="permissions-content">
          <div class="groups-section">
            <h4 class="section-title">User Groups</h4>
            <p class="section-description">Assign user to groups to manage permissions collectively</p>
            <div class="groups-list">
              <div *ngFor="let group of userGroups" class="permission-item">
                <mat-checkbox [checked]="isUserInGroup(group.id)"
                              (change)="toggleUserGroup(group.id, $event.checked)"
                              class="styled-checkbox">
                  <span class="checkbox-label">{{ group.name }}</span>
                  <span class="permission-count" *ngIf="group.permissions">
                    ({{ group.permissions.length }} permissions)
                  </span>
                </mat-checkbox>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Profile Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">account_circle</mat-icon>
          <span class="tab-label">Profile</span>
        </ng-template>

        <form [formGroup]="profileForm" class="profile-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Phone</mat-label>
              <input matInput formControlName="phone">
              <mat-icon matPrefix>phone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Department</mat-label>
              <input matInput formControlName="department">
              <mat-icon matPrefix>business</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Position</mat-label>
              <input matInput formControlName="position">
              <mat-icon matPrefix>work</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="ocean-mint-field">
              <mat-label>Timezone</mat-label>
              <mat-select formControlName="timezone">
                <mat-option value="UTC">UTC</mat-option>
                <mat-option value="America/New_York">Eastern Time</mat-option>
                <mat-option value="America/Chicago">Central Time</mat-option>
                <mat-option value="America/Denver">Mountain Time</mat-option>
                <mat-option value="America/Los_Angeles">Pacific Time</mat-option>
                <mat-option value="Europe/London">London</mat-option>
                <mat-option value="Asia/Dubai">Dubai</mat-option>
              </mat-select>
              <mat-icon matPrefix>access_time</mat-icon>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="ocean-mint-field">
            <mat-label>Bio</mat-label>
            <textarea matInput formControlName="bio" rows="4"></textarea>
            <mat-icon matPrefix>description</mat-icon>
            <mat-hint>Brief description about the user</mat-hint>
          </mat-form-field>
        </form>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeDialog()">Cancel</button>
    <button mat-raised-button
            color="primary"
            (click)="saveUser()"
            [disabled]="!userForm.valid || isSaving">
      <mat-spinner diameter="16" *ngIf="isSaving"></mat-spinner>
      {{ editingUser?.id ? 'Update' : 'Create' }}
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Phone Numbers Dialog -->
<ng-template #phoneNumbersDialog>
  <h2 mat-dialog-title>
    <mat-icon>phone</mat-icon>
    Phone Numbers - {{ selectedUser?.first_name }} {{ selectedUser?.last_name }}
  </h2>

  <mat-dialog-content class="dialog-content">
    <div class="phone-list">
      <div *ngFor="let phone of phoneNumbers" class="phone-item">
        <div class="phone-info">
          <span class="phone-number">{{ phone.phone_number }}</span>
          <div class="phone-badges">
            <mat-chip *ngIf="phone.main" class="status-chip main">Main</mat-chip>
            <mat-chip *ngIf="phone.is_default" class="status-chip default">Default</mat-chip>
          </div>
        </div>
        <div class="phone-actions">
          <button mat-icon-button (click)="editPhoneNumber(phone)" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="deletePhoneNumber(phone)" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <div class="empty-phone" *ngIf="phoneNumbers.length === 0">
        <mat-icon>phone_disabled</mat-icon>
        <p>No phone numbers added yet</p>
      </div>
    </div>

    <form [formGroup]="phoneForm" class="phone-form" *ngIf="editingPhone || addingPhone">
      <h4>{{ editingPhone ? 'Edit' : 'Add' }} Phone Number</h4>
      <div class="form-row">
        <mat-form-field appearance="outline" class="ocean-mint-field">
          <mat-label>Phone Number</mat-label>
          <input matInput formControlName="phone_number" placeholder="+1234567890">
          <mat-icon matPrefix>phone</mat-icon>
          <mat-error *ngIf="phoneForm.get('phone_number')?.hasError('required')">
            Phone number is required
          </mat-error>
          <mat-error *ngIf="phoneForm.get('phone_number')?.hasError('pattern')">
            Invalid phone number format
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="ocean-mint-field">
          <mat-label>Type</mat-label>
          <mat-select formControlName="number_type">
            <mat-option [value]="1">Fax</mat-option>
            <mat-option [value]="2">Phone</mat-option>
            <mat-option [value]="3">Employer</mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>
      </div>

      <div class="checkbox-row">
        <mat-checkbox formControlName="is_default">Default Number</mat-checkbox>
        <mat-checkbox formControlName="main">Main Number</mat-checkbox>
      </div>

      <div class="form-actions">
        <button mat-button (click)="cancelPhoneEdit()">Cancel</button>
        <button mat-raised-button color="primary" (click)="savePhoneNumber()" [disabled]="!phoneForm.valid">
          {{ editingPhone ? 'Update' : 'Add' }}
        </button>
      </div>
    </form>

    <button mat-raised-button
            class="add-phone-btn"
            (click)="startAddingPhone()"
            *ngIf="!editingPhone && !addingPhone">
      <mat-icon>add</mat-icon>
      Add Phone Number
    </button>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closePhoneDialog()">Close</button>
  </mat-dialog-actions>
</ng-template>

<!-- Reset Password Dialog -->
<ng-template #resetPasswordDialog>
  <h2 mat-dialog-title>
    <mat-icon>lock_reset</mat-icon>
    Reset Password
  </h2>

  <mat-dialog-content class="dialog-content">
    <p class="reset-info">
      Reset password for <strong>{{ selectedUser?.first_name }} {{ selectedUser?.last_name }}</strong>
      (&#64;{{ selectedUser?.username }})
    </p>

    <form [formGroup]="resetPasswordForm" class="reset-form">
      <mat-form-field appearance="outline" class="ocean-mint-field">
        <mat-label>New Password</mat-label>
        <input matInput
               [type]="showResetPassword ? 'text' : 'password'"
               formControlName="password">
        <mat-icon matPrefix>lock</mat-icon>
        <button mat-icon-button matSuffix (click)="showResetPassword = !showResetPassword" type="button">
          <mat-icon>{{ showResetPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-error *ngIf="resetPasswordForm.get('password')?.hasError('required')">
          Password is required
        </mat-error>
        <mat-error *ngIf="resetPasswordForm.get('password')?.hasError('minlength')">
          Password must be at least 8 characters
        </mat-error>
        <mat-error *ngIf="resetPasswordForm.get('password')?.hasError('pattern')">
          Must contain upper, lower, number & special char
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="ocean-mint-field">
        <mat-label>Confirm Password</mat-label>
        <input matInput
               [type]="showResetPassword ? 'text' : 'password'"
               formControlName="confirmPassword">
        <mat-icon matPrefix>lock</mat-icon>
        <mat-error *ngIf="resetPasswordForm.get('confirmPassword')?.hasError('required')">
          Please confirm password
        </mat-error>
        <mat-error *ngIf="resetPasswordForm.hasError('passwordMismatch')">
          Passwords do not match
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeResetPasswordDialog()">Cancel</button>
    <button mat-raised-button
            color="primary"
            (click)="confirmResetPassword()"
            [disabled]="!resetPasswordForm.valid || isResettingPassword">
      <mat-spinner diameter="16" *ngIf="isResettingPassword"></mat-spinner>
      Reset Password
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- View User Dialog -->
<!-- View User Dialog -->
<ng-template #viewUserDialog>
  <h2 mat-dialog-title>
    <mat-icon>person</mat-icon>
    User Details
  </h2>

  <mat-dialog-content class="dialog-content user-details-dialog" *ngIf="selectedUser">
    <div class="user-header">
      <div class="user-avatar-large" [style.background]="getUserAvatarColor(selectedUser)">
        <span>{{ getUserInitials(selectedUser) }}</span>
      </div>
      <div class="user-header-info">
        <h3>{{ selectedUser.first_name }} {{ selectedUser.second_name || '' }} {{ selectedUser.third_name || '' }} {{ selectedUser.last_name }}</h3>
        <p>&#64;{{ selectedUser.username }}</p>
        <div class="user-badges">
          <mat-chip *ngIf="selectedUser.is_superuser" class="role-chip superuser">Super Admin</mat-chip>
          <mat-chip *ngIf="selectedUser.is_staff && !selectedUser.is_superuser" class="role-chip staff">Staff</mat-chip>
          <mat-chip *ngIf="selectedUser.is_developer" class="role-chip developer">Developer</mat-chip>
          <mat-chip *ngIf="selectedUser.is_active" class="status-chip active">Active</mat-chip>
          <mat-chip *ngIf="!selectedUser.is_active" class="status-chip inactive">Inactive</mat-chip>
        </div>
      </div>
    </div>

    <div class="details-section">
      <h4>Basic Information</h4>
      <div class="detail-row">
        <span class="detail-label">Email:</span>
        <span class="detail-value">{{ selectedUser.email }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">User Type:</span>
        <span class="detail-value">{{ selectedUser.user_type?.name || 'Not assigned' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Account Verified:</span>
        <span class="detail-value">{{ selectedUser.activated_account ? 'Yes' : 'No' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Last Login:</span>
        <span class="detail-value">{{ formatDate(selectedUser.last_login) }}</span>
      </div>
    </div>

    <div class="details-section" *ngIf="selectedUser.groups && selectedUser.groups.length > 0">
      <h4>Groups</h4>
      <div class="groups-display">
        <mat-chip *ngFor="let group of selectedUser.groups" class="role-chip group">
          {{ group.name }}
        </mat-chip>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeViewDialog()">Close</button>
    <button mat-raised-button color="primary" (click)="editUser(selectedUser!)" *ngIf="selectedUser">
      <mat-icon>edit</mat-icon>
      Edit User
    </button>
  </mat-dialog-actions>
</ng-template>
