<div class="wizard-container">
  <mat-stepper #stepper [linear]="true" class="template-wizard">
    <!-- Step 1: Basic Information -->
    <mat-step [stepControl]="basicInfoForm" label="Basic Information">
      <form [formGroup]="basicInfoForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">info</mat-icon>
          <div>
            <h2>Template Information</h2>
            <p>Provide basic details about your PDF template</p>
          </div>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Template Name</mat-label>
            <input matInput formControlName="name" placeholder="e.g., Employee Report">
            <mat-error *ngIf="basicInfoForm.get('name')?.hasError('required')">
              Name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Template Code</mat-label>
            <input matInput formControlName="code" placeholder="e.g., EMP_REPORT">
            <mat-hint>Unique identifier for the template</mat-hint>
            <mat-error *ngIf="basicInfoForm.get('code')?.hasError('required')">
              Code is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Primary Language</mat-label>
            <mat-select formControlName="primary_language">
              <mat-option value="en">English</mat-option>
              <mat-option value="ar">Arabic</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="checkbox-field">
            <mat-slide-toggle formControlName="supports_bilingual">
              Support Bilingual Content
            </mat-slide-toggle>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="3"
                    placeholder="Describe the purpose of this template"></textarea>
        </mat-form-field>

        <div *ngIf="basicInfoForm.get('supports_bilingual')?.value" class="arabic-fields">
          <mat-divider></mat-divider>
          <h3>Arabic Content</h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Arabic Name</mat-label>
            <input matInput formControlName="name_ara" dir="rtl">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Arabic Description</mat-label>
            <textarea matInput formControlName="description_ara" rows="3" dir="rtl"></textarea>
          </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-button (click)="cancel.emit()">Cancel</button>
          <button mat-button matStepperNext color="primary">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: Page Setup -->
    <mat-step [stepControl]="pageSetupForm" label="Page Setup">
      <form [formGroup]="pageSetupForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">description</mat-icon>
          <div>
            <h2>Page Configuration</h2>
            <p>Set up the page layout and dimensions</p>
          </div>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Page Size</mat-label>
            <mat-select formControlName="page_size">
              <mat-option *ngFor="let size of designerData?.page_sizes || defaultPageSizes" [value]="size.value">
                {{ size.label }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!designerData && !loadingDesignerData">Using default page sizes</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Orientation</mat-label>
            <mat-select formControlName="orientation">
              <mat-option value="portrait">Portrait</mat-option>
              <mat-option value="landscape">Landscape</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="margins-section">
          <h3>Margins (in points)</h3>
          <div class="margins-grid" formGroupName="margins">
            <mat-form-field appearance="outline">
              <mat-label>Top</mat-label>
              <input matInput type="number" formControlName="top">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Bottom</mat-label>
              <input matInput type="number" formControlName="bottom">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Left</mat-label>
              <input matInput type="number" formControlName="left">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Right</mat-label>
              <input matInput type="number" formControlName="right">
            </mat-form-field>
          </div>
        </div>

        <div class="page-options">
          <mat-slide-toggle formControlName="header_enabled">
            Enable Page Header
          </mat-slide-toggle>
          <mat-slide-toggle formControlName="footer_enabled">
            Enable Page Footer
          </mat-slide-toggle>
          <mat-slide-toggle formControlName="watermark_enabled">
            Enable Watermark
          </mat-slide-toggle>
        </div>

        <mat-form-field *ngIf="pageSetupForm.get('watermark_enabled')?.value"
                        appearance="outline" class="full-width">
          <mat-label>Watermark Text</mat-label>
          <input matInput formControlName="watermark_text" placeholder="e.g., CONFIDENTIAL">
        </mat-form-field>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-button matStepperNext color="primary">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 3: Data Source -->
    <mat-step [stepControl]="dataSourceForm" label="Data Source">
      <form [formGroup]="dataSourceForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">storage</mat-icon>
          <div>
            <h2>Data Source Configuration</h2>
            <p>Define how the template will fetch data</p>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Data Source Type</mat-label>
          <mat-select formControlName="data_source_type" (selectionChange)="onDataSourceTypeChange()">
            <mat-option value="model">Model Query</mat-option>
            <mat-option value="raw_sql">Raw SQL</mat-option>
            <mat-option value="custom_function">Custom Function</mat-option>
            <mat-option value="api">External API</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Model Query Configuration -->
        <div *ngIf="dataSourceForm.get('data_source_type')?.value === 'model'" class="model-config">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Model</mat-label>
            <mat-select formControlName="content_type" (selectionChange)="onModelSelected($event.value)">
              <mat-option *ngFor="let ct of contentTypes" [value]="ct.id">
                    <span class="model-option">
                      <strong>{{ ct.app_label }}</strong>.{{ ct.model }}
                    </span>
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="contentTypes.length === 0">No models available. Check API connection.</mat-hint>
          </mat-form-field>

          <div class="query-filter-section">
            <h3>Default Query Filters</h3>
            <p class="hint-text">Add filters that will be applied by default</p>

            <div class="filter-builder">
              <!-- Existing filters -->
              <div class="filters-list" *ngIf="queryFilters.length > 0">
                <div *ngFor="let filter of queryFilters; let i = index" class="filter-row">
                  <!-- Field selection -->
                  <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Field</mat-label>
                    <mat-select [(ngModel)]="filter.field"
                                (selectionChange)="onFilterFieldChange(filter)"
                                [ngModelOptions]="{standalone: true}">
                      <mat-option *ngFor="let field of selectedContentType?.model_fields" [value]="field.name">
                        {{ field.verbose_name }} ({{ field.name }})
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- Operator selection -->
                  <mat-form-field appearance="outline" class="filter-operator" *ngIf="filter.field">
                    <mat-label>Operator</mat-label>
                    <mat-select [(ngModel)]="filter.operator"
                                (selectionChange)="onFilterOperatorChange(filter)"
                                [ngModelOptions]="{standalone: true}">
                      <mat-option *ngFor="let op of getOperatorsForFilter(filter)" [value]="op.value">
                        {{ op.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- Value input -->
                  <mat-form-field appearance="outline" class="filter-value" *ngIf="filter.field">
                    <mat-label>Value</mat-label>
                    <input matInput
                           [(ngModel)]="filter.value"
                           (blur)="onFilterValueChange(filter)"
                           [ngModelOptions]="{standalone: true}">
                  </mat-form-field>

                  <!-- Remove button -->
                  <button mat-icon-button color="warn" (click)="removeQueryFilter(i)" matTooltip="Remove filter">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Add filter button -->
              <button mat-stroked-button (click)="addQueryFilter()" class="add-filter-btn">
                <mat-icon>add</mat-icon>
                Add Filter
              </button>

              <!-- Show current query filter JSON -->
              <div class="query-preview" *ngIf="dataSourceForm.get('query_filter')?.value && Object.keys(dataSourceForm.get('query_filter')?.value).length > 0">
                <h4>Query Preview:</h4>
                <pre>{{ dataSourceForm.get('query_filter')?.value | json }}</pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Raw SQL Configuration -->
        <div *ngIf="dataSourceForm.get('data_source_type')?.value === 'raw_sql'" class="sql-config">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>SQL Query</mat-label>
            <textarea matInput formControlName="raw_sql_query" rows="6"
                      placeholder="SELECT * FROM ..."></textarea>

          </mat-form-field>
        </div>

        <!-- Custom Function Configuration -->
        <div *ngIf="dataSourceForm.get('data_source_type')?.value === 'custom_function'" class="function-config">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Function Path</mat-label>
            <input matInput formControlName="custom_function_path"
                   placeholder="e.g., reporting_templates.custom_functions.fetch_employee_data">
            <mat-hint>Python module path to the function</mat-hint>
          </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-button matStepperNext color="primary">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 4: Parameters -->
    <mat-step [stepControl]="parametersForm" label="Parameters">
      <form [formGroup]="parametersForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">tune</mat-icon>
          <div>
            <h2>Template Parameters</h2>
            <p>Define input parameters for the template</p>
          </div>
        </div>

        <mat-slide-toggle formControlName="requires_parameters" class="mb-3">
          Template requires parameters
        </mat-slide-toggle>

        <div *ngIf="parametersForm.get('requires_parameters')?.value" class="parameters-section">
          <div class="parameters-list"
               cdkDropList
               (cdkDropListDropped)="dropParameter($event)">
            <div *ngFor="let param of parameters.controls; let i = index"
                 [formGroupName]="i"
                 class="parameter-item"
                 cdkDrag>
              <div class="parameter-header">
                <mat-icon cdkDragHandle class="drag-handle">drag_indicator</mat-icon>
                <h4>Parameter {{ i + 1 }}</h4>
                <button mat-icon-button (click)="removeParameter(i)" color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="parameter-form">
                <div class="form-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Parameter Key</mat-label>
                    <input matInput formControlName="parameter_key"
                           placeholder="e.g., start_date">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Display Name</mat-label>
                    <input matInput formControlName="display_name"
                           placeholder="e.g., Start Date">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Type</mat-label>
                    <mat-select formControlName="parameter_type">
                      <mat-option *ngFor="let type of designerData?.parameter_types"
                                  [value]="type.value">
                        {{ type.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Widget Type</mat-label>
                    <mat-select formControlName="widget_type">
                      <mat-option *ngFor="let widget of getAvailableWidgets(param.get('parameter_type')?.value)"
                                  [value]="widget.value">
                        {{ widget.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <textarea matInput formControlName="description" rows="2"></textarea>
                </mat-form-field>

                <div class="parameter-options">
                  <mat-checkbox formControlName="is_required">Required</mat-checkbox>
                  <mat-checkbox formControlName="allow_user_override">Allow user override</mat-checkbox>
                </div>
              </div>
            </div>
          </div>

          <button mat-stroked-button (click)="addParameter()" class="add-parameter-btn">
            <mat-icon>add</mat-icon>
            Add Parameter
          </button>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-button matStepperNext color="primary">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 5: Additional Data Sources -->
    <mat-step [stepControl]="dataSourcesForm" label="Additional Data">
      <form [formGroup]="dataSourcesForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">layers</mat-icon>
          <div>
            <h2>Additional Data Sources</h2>
            <p>Add supplementary data sources for the template</p>
          </div>
        </div>

        <div class="data-sources-list">
          <mat-accordion>
            <mat-expansion-panel *ngFor="let source of dataSources.controls; let i = index"
                                 [formGroupName]="i">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{ source.get('display_name')?.value || 'Data Source ' + (i + 1) }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ source.get('fetch_method')?.value || 'Not configured' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="data-source-form">
                <div class="form-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Source Key</mat-label>
                    <input matInput formControlName="source_key"
                           placeholder="e.g., user_cases">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Display Name</mat-label>
                    <input matInput formControlName="display_name"
                           placeholder="e.g., User Cases">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Fetch Method</mat-label>
                    <mat-select formControlName="fetch_method">
                      <mat-option *ngFor="let method of designerData?.fetch_methods"
                                  [value]="method.value">
                        {{ method.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Cache Timeout (seconds)</mat-label>
                    <input matInput type="number" formControlName="cache_timeout"
                           placeholder="0 for no cache">
                  </mat-form-field>
                </div>

                <button mat-button color="warn" (click)="removeDataSource(i)">
                  <mat-icon>delete</mat-icon>
                  Remove Data Source
                </button>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <button mat-stroked-button (click)="addDataSource()" class="add-source-btn">
          <mat-icon>add</mat-icon>
          Add Data Source
        </button>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-button matStepperNext color="primary">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 6: Permissions -->
    <mat-step [stepControl]="permissionsForm" label="Permissions">
      <form [formGroup]="permissionsForm" class="step-content">
        <div class="step-header">
          <mat-icon class="step-icon">security</mat-icon>
          <div>
            <h2>Access Control</h2>
            <p>Configure who can use this template</p>
          </div>
        </div>

        <div class="permissions-options">
          <mat-slide-toggle formControlName="allow_self_generation">
            Allow users to generate reports for themselves
          </mat-slide-toggle>

          <mat-slide-toggle formControlName="allow_other_generation">
            Allow users to generate reports for others
          </mat-slide-toggle>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Restrict to Groups</mat-label>
          <mat-select formControlName="groups" multiple>
            <mat-option *ngFor="let group of availableGroups" [value]="group.id">
              {{ group.name }}
            </mat-option>
          </mat-select>
          <mat-hint>Leave empty for all users</mat-hint>
        </mat-form-field>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-button color="primary" (click)="completeWizard()">
            <mat-icon>check</mat-icon>
            Complete
          </button>
        </div>
      </form>
    </mat-step>
  </mat-stepper>
</div>
